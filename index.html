<html>
<head>
<meta http-equiv = "content-type" content = "application/xhtml+xml; charset = UTF-8" />
<meta content = 'width = device-width, initial-scale = 1.0, maximum-scale = 1.0, user-scalable = 0' name = 'viewport' /><meta name = "viewport" content = "width = device-width, maximum-scale = 1.0, initial-scale = 1.0">
<meta name = "apple-mobile-web-app-capable" content = "yes">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>Chromaris</title>
<script src="phonegap.js"></script>
<script src="jquery.min.js"></script>
<style type="text/css">
body{
background-color:#f00;
}
*{
font-family: 'Arial';
-webkit-user-select:none;
-webkit-backface-visibility:hidden;
}
</style>
<script>
var ddiv;
var animCanv;
var animCtx;
var bgCanv;
var bcCtx;
var bgColor={"r":240, "g":240, "b":240};
var geometryInterval;
var vw=0;
var vh=0;
var front=false;
function init(){
  body.style.backgroundColor="rgb("+ bgColor.r +","+bgColor.g+","+bgColor.b+")";
  ddiv=document.getElementById('debugDiv');
  bgCanv=document.getElementById('bgCanvas');
  bgCtx=bgCanv.getContext("2d");
  bgCtx.textAlign="center";
  bgCtx.textBaseline="middle";
  animCanv=document.getElementById('animCanvas');
  animCtx=animCanv.getContext("2d");

  animCanv.ontouchstart=function(e){touchStart(e);}
  animCanv.ontouchmove=function(e){touchMove(e);}
  animCanv.ontouchend=function(e){touchEnd(e);}
  geometry();
  geometryInterval=window.setInterval("geometryTick()", 100);

  document.addEventListener('deviceready', function () {
accelWatch = navigator.accelerometer.watchAcceleration(accelerometerSuccess, accelerometerError, {frequency: 500 });
    window.plugin.CanvasCamera.initialize(bgCanv);
    onStartClicked();
    }, false);
  }
var accelWatch;
function accelerometerSuccess(e){
  //dbug("x:"+e.x);
  //dbuga("y:"+e.y);
  //dbuga("z:"+e.z);

  }
function accelerometerError(e){
  dbug('Error A');
  }

function onStartClicked(){
  
    var options = {
        quality: 75,
        destinationType: CanvasCamera.DestinationType.DATA_URL,
        encodingType: CanvasCamera.EncodingType.JPEG,
        width: 100,
        height: 100
    };
    window.plugin.CanvasCamera.start(options);
}
function resumeInit(){
  }
function touchStart(e){
  e.preventDefault();
  if(front==false){
    front=true;
    window.plugin.CanvasCamera.setCameraPosition(CanvasCamera.CameraPosition.FRONT);
    bgCanv.style.webkitTransform="scale(-1, 1)";
    }
  else{
    front=false;
    window.plugin.CanvasCamera.setCameraPosition(CanvasCamera.CameraPosition.BACK);
    bgCanv.style.webkitTransform="scale(1, 1)";
    }
  }
function touchMove(e){
  e.preventDefault();
  }
function touchEnd(e){
  e.preventDefault();
  
  }
function oval(x,y,r0,r1,radians,counter){
  var ctx=animCtx;
  var x0=x+r0*Math.cos(radians);
  var y0=y+r0*Math.sin(radians);
  var x1=x+r1*Math.cos(radians+pi/2);
  var y1=y+r1*Math.sin(radians+pi/2);
  var x2=x+r0*Math.cos(radians+pi);
  var y2=y+r0*Math.sin(radians+pi);
  var x3=x+r1*Math.cos(radians-pi/2);
  var y3=y+r1*Math.sin(radians-pi/2);
  var cpx1=x2+r1*Math.cos(radians+pi/2);
  var cpy1=y2+r1*Math.sin(radians+pi/2);
  var cpx0=x0+r1*Math.cos(radians+pi/2);
  var cpy0=y0+r1*Math.sin(radians+pi/2);
  var cpx2=x2+r1*Math.cos(radians-pi/2);
  var cpy2=y2+r1*Math.sin(radians-pi/2);
  var cpx3=x0+r1*Math.cos(radians-pi/2);
  var cpy3=y0+r1*Math.sin(radians-pi/2);
  //plot(x0,y0,"black");
  ctx.beginPath();
  if(counter){
    //plot(cpx3,cpy3,"rgba(255,255,0,1)");
    //plot(cpx2,cpy2,"rgba(0,0,255,1)");
    ctx.moveTo(x0,y0);
    ctx.quadraticCurveTo(cpx3,cpy3,x3,y3);
    ctx.quadraticCurveTo(cpx2,cpy2,x2,y2);
    }
  else{
    //plot(cpx1,cpy1,"rgba(255,0,0,1)");
    //plot(cpx0,cpy0,"rgba(0,255,0,1)");
    ctx.moveTo(x0,y0);
    ctx.quadraticCurveTo(cpx0,cpy0,x1,y1);
    ctx.quadraticCurveTo(cpx1,cpy1,x2,y2);
    }
  ctx.stroke();
  //moveTo beginning
  //bez to perp
  //bez to end 
  }
function bez(ctx,x0,y0,deg0,dist0,x1,y1,deg1,dist1){
  var cp0x=x0+dist0*Math.cos(deg0/180 * Math.PI);
  var cp0y=y0+dist0*Math.sin(deg0/180 * Math.PI);
  var cp1x=x1-dist1*Math.cos(deg1/180 * Math.PI);
  var cp1y=y1-dist1*Math.sin(deg1/ 180 * Math.PI);
  ctx.bezierCurveTo(cp0x, cp0y, cp1x,cp1y, x1,y1);
}
function roundRect(ctx, x, y, width, height, radius, fill, stroke) {
  if (typeof stroke == "undefined" ) {
    stroke = true;
  }
  if (typeof radius === "undefined") {
    radius = 5;
  }
  ctx.beginPath();
  ctx.moveTo(x + radius, y);
  ctx.lineTo(x + width - radius, y);
  ctx.quadraticCurveTo(x + width, y, x + width, y + radius);
  ctx.lineTo(x + width, y + height - radius);
  ctx.quadraticCurveTo(x + width, y + height, x + width - radius, y + height);
  ctx.lineTo(x + radius, y + height);
  ctx.quadraticCurveTo(x, y + height, x, y + height - radius);
  ctx.lineTo(x, y + radius);
  ctx.quadraticCurveTo(x, y, x + radius, y);
  ctx.closePath();
  if (stroke) {
    ctx.stroke();
  }
  if (fill) {
    ctx.fill();
  }        
}

function rnd(range){
  return Math.floor(Math.random()*range);
  }
function normalRgb(rgb){
  var max=rgb["r"];
  if(rgb["g"]>max){max=rgb["g"];}
  if(rgb["b"]>max){max=rgb["b"];}

  var redFrac=rgb["r"]/max;
  var greenFrac=rgb["g"]/max;
  var blueFrac=rgb["b"]/max;
  return {"r":redFrac, "g":greenFrac, "b":blueFrac, "max":max/255};
  }
var retRad=24;
var sampleRad=8;
function reticule(color){
  animCtx.lineWidth=2;
  animCtx.strokeStyle=color;
  animCtx.beginPath();
  animCtx.moveTo(cx-retRad, cy);     
  animCtx.lineTo(cx-retRad/3, cy);  
  animCtx.moveTo(cx+retRad, cy);     
  animCtx.lineTo(cx+retRad/3, cy);  
  animCtx.moveTo(cx,cy-retRad);
  animCtx.lineTo(cx,cy-retRad/3);  
  animCtx.moveTo(cx,cy+retRad);
  animCtx.lineTo(cx,cy+retRad/3);  
  animCtx.stroke(); 
}
function unblock(){
  blocking=false;
  }
var blocking=false;
function loadAndPlayAudio(url) {
  dbuga("loadAndPlayAudio("+url+")");
  if(blocking==false){
    window.clearTimeout(blockTimeout)
    blockTimeout=window.setTimeout("unblock()", 2000);
    blocking=true;
    // Play the audio file at url
    var my_media = new Media(url,
        // success callback
        function () {
            console.log("playAudio():Audio Success");
        },
        // error callback
        function (err) {
            console.log("playAudio():Audio Error: " + err);
        }
    );
    // Play audio
    my_media.play();
  }
}
var blockTimeout;
function geometryTick(){
  //dbug('');
  var samples=[{"x":0,"y":0}, {"x":retRad*2-1,"y":0}, {"x":retRad*2-1,"y":retRad*2-1}, {"x":0, "y":retRad*2-1}];
  
  animCtx.clearRect(cx-retRad-sampleRad, cy-retRad-sampleRad, (retRad+sampleRad)*2, (retRad+sampleRad)*2);
  var myImageData = bgCtx.getImageData(cx-retRad, cy-retRad, retRad*2, retRad*2);
  var foundGlom="|";
  var foundByColor={"red":0, "orange":0, "yellow":0, "green":0, "blue":0};
  for (var s=0; s<samples.length; s++){
    var offsetX=4*samples[s].x;
    var offsetY=samples[s].y*4*retRad*2;
    var offset=offsetX+offsetY;
    var rgb={"r":myImageData.data[""+(offset)], "g":myImageData.data[""+(offset+1)], "b":myImageData.data[""+(offset+2)]};
    samples[s].rgb=rgb;
    samples[s].nRgb=normalRgb(rgb);
    //dbuga(offset+" "+JSON.stringify(samples[s].rgb)+" "+JSON.stringify(samples[s].nRgb));

    animCtx.beginPath();
    animCtx.arc(cx+samples[s].x-retRad, cy+samples[s].y-retRad, sampleRad, 0, pi*2, true);
    if((saturationRgb(samples[s].nRgb)>.6)&&(samples[s].nRgb.max>.5)){
      var colorName=colorNearestRgb(samples[s].nRgb);
      foundGlom+=colorName+"|";
      foundByColor[colorName]++;
      var lockWas=lockByColorName[colorName];
      lockByColorName[colorName]+=.05;
      if(lockByColorName[colorName]>1){lockByColorName[colorName]=1;}
      if((lockByColorName[colorName]==1)&&(lockWas != 1)){loadAndPlayAudio("cockpitmp3/"+colorName+".mp3");}
      var rgb=rgbByColorName(colorName);
      animCtx.fillStyle="rgb("+Math.floor(rgb["r"]*255)+", "+Math.floor(rgb["g"]*255)+", "+Math.floor(rgb["b"]*255)+")";
      animCtx.fill()
      animCtx.strokeStyle="white";
      animCtx.stroke();
      }
    else{
      animCtx.strokeStyle="black";
      animCtx.stroke();
      }
    }
  //fade the not found colors lock - prevents jitter at 1
  for (var c=0; c<colorNames.length; c++){
    if(foundByColor[colorNames[c]]<3){
      lockByColorName[colorNames[c]]-=.15;
      if(lockByColorName[colorNames[c]]<0){lockByColorName[colorNames[c]]=0;}
      }
    }

  var highestFrac=0;
  var highestColorName="";
  for (var c=0; c<colorNames.length; c++){
    if(lockByColorName[colorNames[c]]>highestFrac){
      highestFrac=lockByColorName[colorNames[c]];
      highestColorName=colorNames[c];
      }
    }
  //dbuga("highestFrac="+ highestFrac);
  //dbuga("highestColorName ="+ highestColorName);

  animCtx.lineWidth=8;
  animCtx.strokeStyle="rgba(255,255,255,.5)";
  animCtx.beginPath();
  animCtx.arc(cx,cy,retRad*2,0,pi*2,true);
  animCtx.stroke();
  if(highestColorName !=""){
    animCtx.lineWidth=3;
    animCtx.strokeStyle=highestColorName;
    animCtx.beginPath();
    animCtx.arc(cx,cy,retRad*2,0,pi*2*highestFrac,false);
    animCtx.stroke();
    }
  if(highestFrac==1){
    reticule("white");
    }
  else{
    reticule("black");
    }

  //dbug("max="+max);
  //dbuga("redFrac="+Math.floor(redFrac*100)/100);
  //dbuga("greenFrac="+Math.floor(greenFrac*100)/100);
  //dbuga("blueFrac="+Math.floor(blueFrac*100)/100);
  //dbug(colorNearestRgb(redFrac,greenFrac,blueFrac));
  //dbuga("saturationRgb="+saturationRgb(redFrac,greenFrac,blueFrac));
  if((window.innerWidth != vw)||(window.innerHeight != vh)){
    geometry();
    }
  }
var cw=0; 
var ch=0;
var cellsAcross=10;
var cellsDown=20;

var leftPad=0;
var topPad=0;
var cx=0; 
var cy=0;
var g=76.8;
var colors=[
  {"name":"red", "r":1, "g":.25, "b":.3},
  {"name":"orange", "r":1, "g":.6, "b":.3},
  {"name":"yellow", "r":1, "g":.8, "b":.25},
  {"name":"green", "r":.3, "g":1, "b":.6},
  {"name":"blue", "r":.2, "g":.3, "b":1}
  ];
var colorNames=["red","orange","yellow","green","blue"];
function rgbByColorName(colorName){
  var rgb={"r":0, "g":0, "b":0};
  for (var c=0; c<colors.length; c++){
    if(colors[c].name==colorName){
      rgb={"r":colors[c].r, "g":colors[c].g, "b":colors[c].b};
      }
    }
  return rgb;
  }
var lockByColorName={"red":0, "orange":0, "yellow":0, "green":0, "blue":0};
function saturationRgb(rgb){
  var deltaRG=Math.abs(rgb["r"]-rgb["g"]);
  var deltaGB=Math.abs(rgb["g"]-rgb["b"]);
  var deltaBR=Math.abs(rgb["b"]-rgb["r"]);
  var saturation=(deltaRG+deltaGB+deltaBR)/2;
  return saturation;
  }
function colorNearestRgb(rgb){
  var nearestName="";
  var nearestDist=10;
  for (var c=0; c<colors.length; c++){
    var dist=0;
    dist+=Math.abs(rgb.r-colors[c].r);
    dist+=Math.abs(rgb.g-colors[c].g);
    dist+=Math.abs(rgb.b-colors[c].b);
    if(dist<nearestDist){
      nearestDist=dist;
      nearestName=colors[c].name;
      }
    }
  return nearestName;
  }
function geometry(){
  vw=window.innerWidth;
  vh=window.innerHeight;
  var vAspect=vw/vh;
  var cAspect=768/1024;
  leftPad=0;
  topPad=0;
  bgCanv.width=vw;
  bgCanv.height=vh;
  bgCanv.style.left=leftPad+"px";
  bgCanv.style.top=topPad+"px";
  bgCanv.style.width=vw+"px";
  bgCanv.style.height=vh+"px";
  //bgCtx.scale(-1, 1)
  animCanv.width=vw;
  animCanv.height=vh;
  animCanv.style.width=vw+"px";
  animCanv.style.height=vh+"px";
  animCanv.style.left=leftPad+"px";
  animCanv.style.top=topPad+"px";
  cx=vw/2;
  cy=vh/2;
  //drawGrid(animCtx);

  }

function drawGrid(ctx){

  ctx.lineWidth=2;
  ctx.strokeStyle="#aaf";
  ctx.beginPath();
  for (var l=0; l<=vh; l+=g){
    ctx.moveTo(0,l);
    ctx.lineTo(vw,l);
    }
  for (var l=0; l<=vw; l+=g){
    ctx.moveTo(l,0);
    ctx.lineTo(l,vh);
    }
  ctx.stroke();

  }
var pi=Math.PI;
function dbug(str) {
  if(str==''){
    ddiv.style.display = "none";
    }
  else{ddiv.style.display = "block";}
  ddiv.innerHTML = str;
  }
function dbuga(str) {
  ddiv.style.display = "block";
  ddiv.innerHTML += "<br />"+str;
  }

</script>
</head>
<body id="body" onload="init()" >
<canvas id="bgCanvas" style="background-color:#fcc; position:absolute; margin:0px; left:0; top:0;"></canvas>
<canvas id="animCanvas" style="position:absolute; margin:0px; left:0; top:0;"></canvas>
<div id="debugDiv" style="position:absolute; margin:20px; background-color:rgba(255,255,255,.35);"></div>
</body>
</html>





